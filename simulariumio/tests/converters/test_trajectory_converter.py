#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pytest

from simulariumio import TrajectoryConverter
from simulariumio.tests.conftest import (
    three_default_agents,
    mixed_agents,
    fiber_agents,
    default_agents_type_mapping,
)
from simulariumio.constants import (
    VIZ_TYPE,
    DISPLAY_TYPE,
    DEFAULT_CAMERA_SETTINGS,
    CURRENT_VERSION,
)
from simulariumio.exceptions import DataError


def fiber_agents_default_viz_type():
    result = fiber_agents()
    result.agent_data.viz_types[1][1] = VIZ_TYPE.DEFAULT
    return result


def default_agents_fiber_viz_type():
    result = three_default_agents()
    result.agent_data.viz_types[1][1] = VIZ_TYPE.FIBER
    return result


def mixed_agents_missing_subpoints():
    result = mixed_agents()
    result.agent_data.viz_types[2][1] = VIZ_TYPE.FIBER
    result.agent_data.display_data["Q"].display_type = DISPLAY_TYPE.FIBER
    return result


def mixed_agents_extra_subpoints():
    result = mixed_agents()
    result.agent_data.viz_types[0][2] = VIZ_TYPE.DEFAULT
    result.agent_data.display_data["C"].display_type = DISPLAY_TYPE.SPHERE
    return result


def mixed_agents_wrong_display_type1():
    result = mixed_agents()
    result.agent_data.display_data["A"].display_type = DISPLAY_TYPE.SPHERE
    return result


def mixed_agents_wrong_display_type2():
    result = mixed_agents()
    result.agent_data.display_data["Q"].display_type = DISPLAY_TYPE.FIBER
    return result


@pytest.mark.parametrize(
    "trajectory, expected_data",
    [
        # 3 default agents (radius 5-10) at given positions for 3 frames,
        # test string for plots
        (
            three_default_agents(),
            {
                "trajectoryInfo": {
                    "version": CURRENT_VERSION.TRAJECTORY_INFO,
                    "timeUnits": {
                        "magnitude": 1.0,
                        "name": "ns",
                    },
                    "timeStepSize": 0.5,
                    "totalSteps": 3,
                    "spatialUnits": {
                        "magnitude": 1.0,
                        "name": "nm",
                    },
                    "size": {"x": 100.0, "y": 100.0, "z": 100.0},
                    "cameraDefault": {
                        "position": {
                            "x": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[0],
                            "y": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[1],
                            "z": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[2],
                        },
                        "lookAtPosition": {
                            "x": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[0],
                            "y": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[1],
                            "z": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[2],
                        },
                        "upVector": {
                            "x": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[0],
                            "y": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[1],
                            "z": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[2],
                        },
                        "fovDegrees": DEFAULT_CAMERA_SETTINGS.FOV_DEGREES,
                    },
                    "typeMapping": default_agents_type_mapping(),
                },
                "spatialData": {
                    "version": CURRENT_VERSION.SPATIAL_DATA,
                    "msgType": 1,
                    "bundleStart": 0,
                    "bundleSize": 3,
                    "bundleData": [
                        {
                            "frameNumber": 0,
                            "time": 0.0,
                            "data": [
                                1000.0,
                                0.0,
                                0.0,
                                4.89610492,
                                -29.81564851,
                                40.77254057,
                                40.77254057,
                                -29.81564851,
                                4.89610492,
                                8.38656327,
                                0.0,
                                1000.0,
                                1.0,
                                1.0,
                                43.43048197,
                                48.00424379,
                                -36.02881338,
                                -36.02881338,
                                48.00424379,
                                43.43048197,
                                6.18568039,
                                0.0,
                                1000.0,
                                2.0,
                                0.0,
                                29.84924588,
                                -38.02769707,
                                2.46644825,
                                2.46644825,
                                -38.02769707,
                                29.84924588,
                                6.61459206,
                                0.0,
                            ],
                        },
                        {
                            "frameNumber": 1,
                            "time": 0.5,
                            "data": [
                                1000.0,
                                0.0,
                                1.0,
                                -43.37181102,
                                -13.41127423,
                                -17.31316927,
                                -17.31316927,
                                -13.41127423,
                                -43.37181102,
                                5.26366739,
                                0.0,
                                1000.0,
                                1.0,
                                2.0,
                                9.62132397,
                                13.4774314,
                                -20.30846039,
                                -20.30846039,
                                13.4774314,
                                9.62132397,
                                6.69209780,
                                0.0,
                                1000.0,
                                2.0,
                                3.0,
                                41.41039848,
                                -45.85543786,
                                49.06208485,
                                49.06208485,
                                -45.85543786,
                                41.41039848,
                                9.88033853,
                                0.0,
                            ],
                        },
                        {
                            "frameNumber": 2,
                            "time": 1.0,
                            "data": [
                                1000.0,
                                0.0,
                                4.0,
                                -24.91450698,
                                -44.79360525,
                                13.32273796,
                                13.32273796,
                                -44.79360525,
                                -24.91450698,
                                8.91022619,
                                0.0,
                                1000.0,
                                1.0,
                                5.0,
                                4.10861266,
                                43.86451151,
                                21.93697483,
                                21.93697483,
                                43.86451151,
                                4.10861266,
                                9.01379396,
                                0.0,
                                1000.0,
                                2.0,
                                6.0,
                                -7.16740679,
                                -13.06491594,
                                44.97026158,
                                44.97026158,
                                -13.06491594,
                                -7.16740679,
                                8.39880154,
                                0.0,
                            ],
                        },
                    ],
                },
                "plotData": {"version": CURRENT_VERSION.PLOT_DATA, "data": []},
            },
        ),
        # # 2 default agents (radius 5-10) and 3 fiber agents
        # # at given positions for 3 frames, no plots
        (
            mixed_agents(),
            {
                "trajectoryInfo": {
                    "version": CURRENT_VERSION.TRAJECTORY_INFO,
                    "trajectoryTitle": "low concentrations",
                    "modelInfo": {
                        "title": "Some agent-based model",
                        "version": "8.1",
                        "authors": "A Modeler",
                        "description": (
                            "An agent-based model started with "
                            "low agent concentrations"
                        ),
                        "doi": "10.7554/eLife.49840",
                        "inputDataUrl": "https://allencell.org",
                    },
                    "timeUnits": {
                        "magnitude": 1.0,
                        "name": "s",
                    },
                    "timeStepSize": 1.0,
                    "totalSteps": 3,
                    "spatialUnits": {
                        "magnitude": 1.0,
                        "name": "µm",
                    },
                    "size": {"x": 1000.0, "y": 1000.0, "z": 1000.0},
                    "cameraDefault": {
                        "position": {"x": 0, "y": 120, "z": 0},
                        "lookAtPosition": {"x": 10, "y": 0, "z": 0},
                        "upVector": {"x": 0, "y": 0, "z": 1},
                        "fovDegrees": 60.0,
                    },
                    "typeMapping": {
                        "0": {
                            "name": "H",
                            "geometry": {
                                "displayType": "SPHERE",
                            },
                        },
                        "1": {
                            "name": "A",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "2": {
                            "name": "C",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "3": {
                            "name": "X",
                            "geometry": {
                                "displayType": "SPHERE",
                            },
                        },
                        "4": {
                            "name": "J",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "5": {
                            "name": "L",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "6": {
                            "name": "D",
                            "geometry": {
                                "displayType": "SPHERE",
                            },
                        },
                        "7": {
                            "name": "U",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "8": {
                            "name": "E",
                            "geometry": {
                                "displayType": "SPHERE",
                            },
                        },
                        "9": {
                            "name": "Q",
                            "geometry": {
                                "displayType": "SPHERE",
                            },
                        },
                        "10": {
                            "name": "K",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                    },
                },
                "spatialData": {
                    "version": CURRENT_VERSION.SPATIAL_DATA,
                    "msgType": 1,
                    "bundleStart": 0,
                    "bundleSize": 3,
                    "bundleData": [
                        {
                            "frameNumber": 0,
                            "time": 0.0,
                            "data": [
                                1000.0,
                                0.0,
                                0.0,
                                4.89610492,
                                -29.81564851,
                                40.77254057,
                                0.0,
                                0.0,
                                0.0,
                                8.38656327,
                                0.0,
                                1001.0,
                                1.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -243.14059805,
                                207.75566987,
                                -95.33921063,
                                -20.54663446,
                                475.97201603,
                                14.43506311,
                                -76.45581828,
                                -97.31170699,
                                -144.30184731,
                                1001.0,
                                2.0,
                                2.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                12.0,
                                108.28447939,
                                175.55049775,
                                -274.34792273,
                                13.44237701,
                                258.21483663,
                                -65.05452787,
                                224.55922362,
                                -455.56482869,
                                -351.23389958,
                                -286.95502659,
                                330.12683064,
                                183.79420473,
                                1000.0,
                                3.0,
                                3.0,
                                43.43048197,
                                48.00424379,
                                -36.02881338,
                                0.0,
                                0.0,
                                0.0,
                                6.18568039,
                                0.0,
                                1001.0,
                                4.0,
                                4.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                49.76236816,
                                -353.11708296,
                                226.84570983,
                                -234.5462914,
                                105.46507228,
                                17.16552317,
                            ],
                        },
                        {
                            "frameNumber": 1,
                            "time": 1.0,
                            "data": [
                                1001.0,
                                0.0,
                                5.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -442.27202981,
                                202.83568625,
                                -262.13407113,
                                -372.23130078,
                                217.21997368,
                                404.88561338,
                                171.37918011,
                                205.80515525,
                                -65.95336727,
                                1000.0,
                                1.0,
                                6.0,
                                -43.37181102,
                                -13.41127423,
                                -17.31316927,
                                0.0,
                                0.0,
                                0.0,
                                6.69209780,
                                0.0,
                                1001.0,
                                2.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                245.9111405,
                                372.15936027,
                                -261.94702214,
                                3.50037066,
                                441.92904046,
                                321.75701298,
                                146.23928574,
                                -315.3241668,
                                82.00405173,
                                1001.0,
                                3.0,
                                7.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                104.82606074,
                                -413.76671598,
                                366.66127719,
                                136.7228888,
                                -210.69313998,
                                -465.59967482,
                                1000.0,
                                4.0,
                                6.0,
                                9.62132397,
                                13.4774314,
                                -20.30846039,
                                0.0,
                                0.0,
                                0.0,
                                9.88033853,
                                0.0,
                            ],
                        },
                        {
                            "frameNumber": 2,
                            "time": 2.0,
                            "data": [
                                1000.0,
                                0.0,
                                8.0,
                                -24.91450698,
                                -44.79360525,
                                13.32273796,
                                0.0,
                                0.0,
                                0.0,
                                8.91022619,
                                0.0,
                                1000.0,
                                1.0,
                                9.0,
                                4.10861266,
                                43.86451151,
                                21.93697483,
                                0.0,
                                0.0,
                                0.0,
                                9.01379396,
                                0.0,
                                1001.0,
                                2.0,
                                10.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -148.70447678,
                                225.27562348,
                                -273.51318785,
                                -5.32043612,
                                -55.97783429,
                                413.32948686,
                                165.64239994,
                                322.63703294,
                                -2.2348818,
                                1001.0,
                                3.0,
                                10.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                -317.48515644,
                                -237.70246887,
                                238.69661676,
                                94.56942257,
                                346.13786088,
                                -7.93209392,
                                1001.0,
                                4.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                7.77508859,
                                260.16762947,
                                -171.02427873,
                                -20.46326319,
                                179.43194042,
                                485.07810635,
                            ],
                        },
                    ],
                },
                "plotData": {
                    "version": CURRENT_VERSION.PLOT_DATA,
                    "data": ["plot data goes here"],
                },
            },
        ),
        # 3 fiber agents with points drawn
        # at given positions for 3 frames, no plots
        (
            fiber_agents(),
            {
                "trajectoryInfo": {
                    "version": CURRENT_VERSION.TRAJECTORY_INFO,
                    "modelInfo": {
                        "title": "Some fibers",
                        "authors": "A Modeler",
                    },
                    "timeUnits": {
                        "magnitude": 1.0,
                        "name": "µs",
                    },
                    "timeStepSize": 1.0,
                    "totalSteps": 3,
                    "spatialUnits": {
                        "magnitude": 10.0,
                        "name": "m",
                    },
                    "size": {"x": 1000.0, "y": 1000.0, "z": 1000.0},
                    "cameraDefault": {
                        "position": {
                            "x": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[0],
                            "y": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[1],
                            "z": DEFAULT_CAMERA_SETTINGS.CAMERA_POSITION[2],
                        },
                        "lookAtPosition": {
                            "x": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[0],
                            "y": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[1],
                            "z": DEFAULT_CAMERA_SETTINGS.LOOK_AT_POSITION[2],
                        },
                        "upVector": {
                            "x": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[0],
                            "y": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[1],
                            "z": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[2],
                        },
                        "fovDegrees": DEFAULT_CAMERA_SETTINGS.FOV_DEGREES,
                    },
                    "typeMapping": {
                        "0": {
                            "name": "H",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "1": {
                            "name": "A",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "2": {
                            "name": "C",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "3": {
                            "name": "L",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "4": {
                            "name": "D",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                        "5": {
                            "name": "K",
                            "geometry": {
                                "displayType": "FIBER",
                            },
                        },
                    },
                },
                "spatialData": {
                    "version": CURRENT_VERSION.SPATIAL_DATA,
                    "msgType": 1,
                    "bundleStart": 0,
                    "bundleSize": 3,
                    "bundleData": [
                        {
                            "frameNumber": 0,
                            "time": 0.0,
                            "data": [
                                1001.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -243.14059805,
                                207.75566987,
                                -95.33921063,
                                -20.54663446,
                                475.97201603,
                                14.43506311,
                                -76.45581828,
                                -97.31170699,
                                -144.30184731,
                                1000.0,
                                200.0,
                                0.0,
                                -243.14059805,
                                207.75566987,
                                -95.33921063,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1000.0,
                                202.0,
                                0.0,
                                -76.45581828,
                                -97.31170699,
                                -144.30184731,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                2.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                12.0,
                                108.28447939,
                                175.55049775,
                                -274.34792273,
                                13.44237701,
                                258.21483663,
                                -65.05452787,
                                224.55922362,
                                -455.56482869,
                                -351.23389958,
                                -286.95502659,
                                330.12683064,
                                183.79420473,
                                1000.0,
                                300.0,
                                1.0,
                                108.28447939,
                                175.55049775,
                                -274.34792273,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1000.0,
                                302.0,
                                1.0,
                                224.55922362,
                                -455.56482869,
                                -351.23389958,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                3.0,
                                2.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                49.76236816,
                                -353.11708296,
                                226.84570983,
                                -234.5462914,
                                105.46507228,
                                17.16552317,
                                1000.0,
                                400.0,
                                2.0,
                                49.76236816,
                                -353.11708296,
                                226.84570983,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                            ],
                        },
                        {
                            "frameNumber": 1,
                            "time": 1.00001,
                            "data": [
                                1001.0,
                                1.0,
                                3.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -442.27202981,
                                202.83568625,
                                -262.13407113,
                                -372.23130078,
                                217.21997368,
                                404.88561338,
                                171.37918011,
                                205.80515525,
                                -65.95336727,
                                1000.0,
                                200.0,
                                3.0,
                                -442.27202981,
                                202.83568625,
                                -262.13407113,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1000.0,
                                202.0,
                                3.0,
                                171.37918011,
                                205.80515525,
                                -65.95336727,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                2.0,
                                4.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                245.9111405,
                                372.15936027,
                                -261.94702214,
                                3.50037066,
                                441.92904046,
                                321.75701298,
                                146.23928574,
                                -315.3241668,
                                82.00405173,
                                1000.0,
                                300.0,
                                4.0,
                                245.9111405,
                                372.15936027,
                                -261.94702214,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1000.0,
                                302.0,
                                4.0,
                                146.23928574,
                                -315.3241668,
                                82.00405173,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                3.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                104.82606074,
                                -413.76671598,
                                366.66127719,
                                136.7228888,
                                -210.69313998,
                                -465.59967482,
                                1000.0,
                                400.0,
                                1.0,
                                104.82606074,
                                -413.76671598,
                                366.66127719,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                            ],
                        },
                        {
                            "frameNumber": 2,
                            "time": 2.00001,
                            "data": [
                                1001.0,
                                1.0,
                                5.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -148.70447678,
                                225.27562348,
                                -273.51318785,
                                -5.32043612,
                                -55.97783429,
                                413.32948686,
                                165.64239994,
                                322.63703294,
                                -2.2348818,
                                1000.0,
                                200.0,
                                5.0,
                                -148.70447678,
                                225.27562348,
                                -273.51318785,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1000.0,
                                202.0,
                                5.0,
                                165.64239994,
                                322.63703294,
                                -2.2348818,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                2.0,
                                5.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                -317.48515644,
                                -237.70246887,
                                238.69661676,
                                94.56942257,
                                346.13786088,
                                -7.93209392,
                                1000.0,
                                300.0,
                                5.0,
                                -317.48515644,
                                -237.70246887,
                                238.69661676,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                                1001.0,
                                3.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                6.0,
                                7.77508859,
                                260.16762947,
                                -171.02427873,
                                -20.46326319,
                                179.43194042,
                                485.07810635,
                                1000.0,
                                400.0,
                                1.0,
                                7.77508859,
                                260.16762947,
                                -171.02427873,
                                0.0,
                                0.0,
                                0.0,
                                0.5,
                                0.0,
                            ],
                        },
                    ],
                },
                "plotData": {
                    "version": CURRENT_VERSION.PLOT_DATA,
                    "data": ["plot data goes here"],
                },
            },
        ),
        # subpoints and viz or display types are inconsistent
        pytest.param(
            fiber_agents_default_viz_type(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
        pytest.param(
            default_agents_fiber_viz_type(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
        pytest.param(
            mixed_agents_missing_subpoints(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
        pytest.param(
            mixed_agents_extra_subpoints(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
        pytest.param(
            mixed_agents_wrong_display_type1(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
        pytest.param(
            mixed_agents_wrong_display_type2(),
            {},
            marks=pytest.mark.raises(exception=DataError),
        ),
    ],
)
def test_trajectory_reader(trajectory, expected_data):
    converter = TrajectoryConverter(trajectory)
    buffer_data = converter._read_trajectory_data(converter._data)
    assert expected_data == buffer_data
    assert converter._check_agent_ids_are_unique_per_frame(buffer_data)
