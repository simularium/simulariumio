#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pytest
import numpy as np

from simulariumio.cellpack import (
    CellpackConverter,
    HAND_TYPE,
    CellpackData,
)
from simulariumio import InputFileData, UnitData
from simulariumio.constants import (
    DEFAULT_CAMERA_SETTINGS,
    CURRENT_VERSION,
    DISPLAY_TYPE,
)


@pytest.mark.parametrize(
    "trajectory, expected_data",
    [
        # 2D
        (
            CellpackData(
                results_file=InputFileData(
                    file_path="simulariumio/tests/data/cellpack/example_2D_results.json"
                ),
                geometry_type=DISPLAY_TYPE.OBJ,
                recipe_file_path="simulariumio/tests/data/cellpack/example_2D_recipe.json",
                time_units=UnitData("ns"),  # nanoseconds
                spatial_units=UnitData("nm"),  # nanometers
                handedness=HAND_TYPE.LEFT,
                geometry_url="https://aics-simularium-data.s3.us-east-2.amazonaws.com/meshes/obj/",
            ),
            {
                "trajectoryInfo": {
                    "version": CURRENT_VERSION.TRAJECTORY_INFO,
                    "timeUnits": {"magnitude": 1.0, "name": "ns"},
                    "timeStepSize": 0.0,
                    "totalSteps": 1,
                    "spatialUnits": {"magnitude": 10.0, "name": "nm"},
                    "size": {"x": 100.0, "y": 100.0, "z": 0.1},
                    "cameraDefault": {
                        "position": {"x": 10.0, "y": 0.0, "z": 100.0},
                        "lookAtPosition": {"x": 10.0, "y": 0.0, "z": 0.0},
                        "upVector": {
                            "x": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[0],
                            "y": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[1],
                            "z": DEFAULT_CAMERA_SETTINGS.UP_VECTOR[2],
                        },
                        "fovDegrees": 60.0,
                    },
                    "typeMapping": {
                        "0": {
                            "name": "IngredientC_1_1",
                            "geometry": {
                                "displayType": "OBJ",
                                "url": "https://aics-simularium-data.s3.us-east-2.amazonaws.com/meshes/obj/IngredientC_1_2.obj",
                            },
                        },
                        "1": {
                            "name": "snake",
                            "geometry": {
                                "displayType": "FIBER"
                            },
                        },
                        "2": {
                            "name": "Bacteria_Rad25_1_3",
                            "geometry": {
                                "displayType": "OBJ",
                                "url": "https://aics-simularium-data.s3.us-east-2.amazonaws.com/meshes/obj/Bacteria_Rad25_1_4.obj",
                            },
                        },
                    },
                },
                "spatialData": {
                    "version": CURRENT_VERSION.SPATIAL_DATA,
                    "msgType": 1,
                    "bundleStart": 0,
                    "bundleSize": 1,
                    "bundleData": [
                        {
                            "frameNumber": 0,
                            "time": 0.0,
                            "data": [
                                1000.0,
                                0.0,
                                0.0,
                                -20.936301,
                                -34.939883,
                                -0.05,
                                0.0,
                                0.0,
                                1.2412044114730543,
                                1.0,
                                0.0,
                                1000.0,
                                1.0,
                                0.0,
                                22.335352,
                                -24.278128,
                                -0.05,
                                0.0,
                                0.0,
                                -2.0285802353053968,
                                1.0,
                                0.0,
                                1000.0,
                                2.0,
                                0.0,
                                -2.862290999999999,
                                31.867652999999997,
                                -0.05,
                                0.0,
                                0.0,
                                -2.8666072339506092,
                                1.0,
                                0.0,
                                1001.0,
                                3.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                42.0,
                                -498.9039019,
                                -442.876672,
                                -0.5,
                                -495.9149904,
                                -442.876672,
                                -0.5,
                                -493.1672052,
                                -441.672647,
                                -0.5,
                                -490.5250308,
                                -440.251761,
                                -0.5,
                                -487.826815,
                                -438.940414,
                                -0.5,
                                -484.901219,
                                -438.276422,
                                -0.5,
                                -481.90782,
                                -438.475328,
                                -0.5,
                                -479.146181,
                                -439.647228,
                                -0.5,
                                -476.349149,
                                -440.731945,
                                -0.5,
                                -473.479584,
                                -441.606929,
                                -0.5,
                                -470.550817,
                                -442.256796,
                                -0.5,
                                -467.552611,
                                -442.360523,
                                -0.5,
                                -464.860755,
                                -441.03617099999997,
                                -0.5,
                                -462.21858,
                                -439.61528599999997,
                                -0.5,
                                1001.0,
                                4.0,
                                1.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                0.0,
                                1.0,
                                9.0,
                                -408.594051,
                                -400.360779,
                                -0.5,
                                -405.874179,
                                -400.996359,
                                -0.5,
                                -402.885384,
                                -401.255406,
                                -0.5,
                                1000.0,
                                5.0,
                                2.0,
                                -27.040083000000006,
                                21.541914999999996,
                                -0.05,
                                0.0,
                                0.0,
                                0.030966969413770744,
                                1.0,
                                0.0,
                                1000.0,
                                6.0,
                                2.0,
                                -29.574403000000004,
                                -11.557633,
                                -0.05,
                                0.0,
                                0.0,
                                -0.6371777129713793,
                                1.0,
                                0.0,
                                1000.0,
                                7.0,
                                2.0,
                                -42.9782385,
                                -17.88265,
                                -0.05,
                                0.0,
                                0.0,
                                0.18899457164665776,
                                1.0,
                                0.0,
                                1000.0,
                                8.0,
                                2.0,
                                -47.4737334,
                                -37.622001000000004,
                                -0.05,
                                0.0,
                                0.0,
                                0.6558988155935591,
                                1.0,
                                0.0,
                                1000.0,
                                9.0,
                                2.0,
                                -4.922696000000002,
                                -8.422915000000001,
                                -0.05,
                                0.0,
                                0.0,
                                -0.19931846494821182,
                                1.0,
                                0.0,
                                1000.0,
                                10.0,
                                2.0,
                                3.623712999999998,
                                -1.8709709999999973,
                                -0.05,
                                0.0,
                                0.0,
                                -0.4212956104432584,
                                1.0,
                                0.0,
                                1000.0,
                                11.0,
                                2.0,
                                -49.04520262,
                                -48.9605248,
                                -0.05,
                                0.0,
                                0.0,
                                -2.8757378972495404,
                                1.0,
                                0.0,
                                1000.0,
                                12.0,
                                2.0,
                                -9.095863000000003,
                                -1.694198,
                                -0.05,
                                0.0,
                                0.0,
                                -0.2550846981204716,
                                1.0,
                                0.0,
                                1000.0,
                                13.0,
                                2.0,
                                -42.0096419,
                                -4.512842000000001,
                                -0.05,
                                0.0,
                                0.0,
                                1.2913653130404703,
                                1.0,
                                0.0,
                                1000.0,
                                14.0,
                                2.0,
                                22.654697,
                                30.755598,
                                -0.05,
                                0.0,
                                0.0,
                                -0.15403122162258434,
                                1.0,
                                0.0,
                                1000.0,
                                15.0,
                                2.0,
                                40.891728,
                                14.107086000000004,
                                -0.05,
                                0.0,
                                0.0,
                                -0.6052339620779548,
                                1.0,
                                0.0,
                                1000.0,
                                16.0,
                                2.0,
                                19.353657999999996,
                                -9.736491999999998,
                                -0.05,
                                0.0,
                                0.0,
                                -0.05808782403134214,
                                1.0,
                                0.0,
                                1000.0,
                                17.0,
                                2.0,
                                49.49033500000001,
                                -42.872856600000006,
                                -0.05,
                                0.0,
                                0.0,
                                -0.9966859384672707,
                                1.0,
                                0.0,
                                1000.0,
                                18.0,
                                2.0,
                                -20.644177000000003,
                                -2.2541729999999975,
                                -0.05,
                                0.0,
                                0.0,
                                -0.07670895572252477,
                                1.0,
                                0.0,
                                1000.0,
                                19.0,
                                2.0,
                                11.072159,
                                9.899446999999999,
                                -0.05,
                                0.0,
                                0.0,
                                -1.1760710721961454,
                                1.0,
                                0.0,
                                1000.0,
                                20.0,
                                2.0,
                                -47.746743,
                                -24.556,
                                -0.05,
                                0.0,
                                0.0,
                                0.8746198978488748,
                                1.0,
                                0.0,
                                1000.0,
                                21.0,
                                2.0,
                                -35.798074,
                                39.835899,
                                -0.05,
                                0.0,
                                0.0,
                                -0.28704334832629647,
                                1.0,
                                0.0,
                                1000.0,
                                22.0,
                                2.0,
                                -44.562983100000004,
                                40.464815,
                                -0.05,
                                0.0,
                                0.0,
                                -0.07139596722688499,
                                1.0,
                                0.0,
                                1000.0,
                                23.0,
                                2.0,
                                13.795317,
                                1.1604710000000011,
                                -0.05,
                                0.0,
                                0.0,
                                -1.0123512934175734,
                                1.0,
                                0.0,
                                1000.0,
                                24.0,
                                2.0,
                                -23.373295000000002,
                                -29.236304000000004,
                                -0.05,
                                0.0,
                                0.0,
                                -0.7433358060238999,
                                1.0,
                                0.0,
                                1000.0,
                                25.0,
                                2.0,
                                42.717886,
                                23.910186999999997,
                                -0.05,
                                0.0,
                                0.0,
                                -0.858603819428879,
                                1.0,
                                0.0,
                                1000.0,
                                26.0,
                                2.0,
                                5.096840999999995,
                                -48.3715532,
                                -0.05,
                                0.0,
                                0.0,
                                -1.521737840172804,
                                1.0,
                                0.0,
                                1000.0,
                                27.0,
                                2.0,
                                27.343192000000002,
                                -49.66354994,
                                -0.05,
                                0.0,
                                0.0,
                                -1.1172790294061314,
                                1.0,
                                0.0,
                                1000.0,
                                28.0,
                                2.0,
                                -17.441905000000002,
                                -42.1389778,
                                -0.05,
                                0.0,
                                0.0,
                                -1.5672941099852125,
                                1.0,
                                0.0,
                                1000.0,
                                29.0,
                                2.0,
                                23.413996999999995,
                                8.990655000000004,
                                -0.05,
                                0.0,
                                0.0,
                                0.07154627482664534,
                                1.0,
                                0.0,
                                1000.0,
                                30.0,
                                2.0,
                                -45.641367200000005,
                                29.798128999999996,
                                -0.05,
                                0.0,
                                0.0,
                                1.0544849936088427,
                                1.0,
                                0.0,
                                1000.0,
                                31.0,
                                2.0,
                                -32.36477300000001,
                                27.269008,
                                -0.05,
                                0.0,
                                0.0,
                                -0.4073077135874141,
                                1.0,
                                0.0,
                                1000.0,
                                32.0,
                                2.0,
                                27.460074999999996,
                                -28.318667,
                                -0.05,
                                0.0,
                                0.0,
                                -0.686865961298058,
                                1.0,
                                0.0,
                                1000.0,
                                33.0,
                                2.0,
                                -7.365266000000003,
                                25.220971,
                                -0.05,
                                0.0,
                                0.0,
                                1.0361038261829298,
                                1.0,
                                0.0,
                                1000.0,
                                34.0,
                                2.0,
                                3.8411969999999998,
                                37.61997300000001,
                                -0.05,
                                0.0,
                                0.0,
                                -0.15837311390842204,
                                1.0,
                                0.0,
                                1000.0,
                                35.0,
                                2.0,
                                32.821482,
                                13.831125999999996,
                                -0.05,
                                0.0,
                                0.0,
                                -0.15409677964337012,
                                1.0,
                                0.0,
                                1000.0,
                                36.0,
                                2.0,
                                34.238149,
                                32.488493000000005,
                                -0.05,
                                0.0,
                                0.0,
                                0.2477149055137109,
                                1.0,
                                0.0,
                                1000.0,
                                37.0,
                                2.0,
                                43.894241,
                                -36.469428,
                                -0.05,
                                0.0,
                                0.0,
                                -0.5039299705809199,
                                1.0,
                                0.0,
                                1000.0,
                                38.0,
                                2.0,
                                -12.231090000000002,
                                -49.607668100000005,
                                -0.05,
                                0.0,
                                0.0,
                                -1.5630911490027575,
                                1.0,
                                0.0,
                            ],
                        }
                    ],
                },
                "plotData": {"version": CURRENT_VERSION.PLOT_DATA, "data": []},
            },
        ),
    ],
)
def test_cellpack_converter(trajectory, expected_data):
    converter = CellpackConverter(trajectory)
    buffer_data = converter._read_trajectory_data(converter._data)
    assert expected_data == buffer_data
