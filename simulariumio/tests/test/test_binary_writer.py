#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pytest
import numpy as np

from simulariumio import (
    TrajectoryConverter,
    TrajectoryData,
    AgentData,
    UnitData,
    MetaData,
    CameraData,
    BinaryWriter,
)
from simulariumio.constants import BINARY_SETTINGS


# 2 default agents (radius 5-10) and 3 fiber agents
# at given positions for 3 frames, no plots
input_data = TrajectoryData(
    meta_data=MetaData(
        box_size=np.array([1000.0, 1000.0, 1000.0]),
        camera_defaults=CameraData(
            position=np.array([0.0, 120.0, 0.0]),
            look_at_position=np.array([10.0, 0.0, 0.0]),
            up_vector=np.array([0.0, 0.0, 1.0]),
            fov_degrees=60.0,
        ),
    ),
    agent_data=AgentData(
        times=1.0 * np.array(list(range(3))),
        n_agents=np.array(3 * [5]),
        viz_types=np.array(
            [
                [1000.0, 1001.0, 1001.0, 1000.0, 1001.0],
                [1001.0, 1000.0, 1001.0, 1001.0, 1000.0],
                [1000.0, 1000.0, 1001.0, 1001.0, 1001.0],
            ]
        ),
        unique_ids=np.array(
            [
                [0.0, 1.0, 2.0, 3.0, 4.0],
                [0.0, 1.0, 2.0, 3.0, 4.0],
                [0.0, 1.0, 2.0, 3.0, 4.0],
            ]
        ),
        types=[
            ["H", "A", "C", "X", "J"],
            ["L", "D", "A", "U", "D"],
            ["E", "Q", "K", "K", "A"],
        ],
        positions=np.array(
            [
                [
                    [4.89610492, -29.81564851, 40.77254057],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [43.43048197, 48.00424379, -36.02881338],
                    [0.0, 0.0, 0.0],
                ],
                [
                    [0.0, 0.0, 0.0],
                    [-43.37181102, -13.41127423, -17.31316927],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [9.62132397, 13.4774314, -20.30846039],
                ],
                [
                    [-24.91450698, -44.79360525, 13.32273796],
                    [4.10861266, 43.86451151, 21.93697483],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                ],
            ]
        ),
        radii=np.array(
            [
                [8.38656327, 1.0, 1.0, 6.18568039, 1.0],
                [1.0, 6.69209780, 1.0, 1.0, 9.88033853],
                [8.91022619, 9.01379396, 1.0, 1.0, 1.0],
            ]
        ),
        n_subpoints=np.array([[0, 3, 4, 0, 2], [3, 0, 3, 2, 0], [0, 0, 3, 2, 2]]),
        subpoints=np.array(
            [
                [
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [-243.14059805, 207.75566987, -95.33921063],
                        [-20.54663446, 475.97201603, 14.43506311],
                        [-76.45581828, -97.31170699, -144.30184731],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [108.28447939, 175.55049775, -274.34792273],
                        [13.44237701, 258.21483663, -65.05452787],
                        [224.55922362, -455.56482869, -351.23389958],
                        [-286.95502659, 330.12683064, 183.79420473],
                    ],
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [49.76236816, -353.11708296, 226.84570983],
                        [-234.5462914, 105.46507228, 17.16552317],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                ],
                [
                    [
                        [-442.27202981, 202.83568625, -262.13407113],
                        [-372.23130078, 217.21997368, 404.88561338],
                        [171.37918011, 205.80515525, -65.95336727],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [245.9111405, 372.15936027, -261.94702214],
                        [3.50037066, 441.92904046, 321.75701298],
                        [146.23928574, -315.3241668, 82.00405173],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [104.82606074, -413.76671598, 366.66127719],
                        [136.7228888, -210.69313998, -465.59967482],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                ],
                [
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [-148.70447678, 225.27562348, -273.51318785],
                        [-5.32043612, -55.97783429, 413.32948686],
                        [165.64239994, 322.63703294, -2.2348818],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [-317.48515644, -237.70246887, 238.69661676],
                        [94.56942257, 346.13786088, -7.93209392],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                    [
                        [7.77508859, 260.16762947, -171.02427873],
                        [-20.46326319, 179.43194042, 485.07810635],
                        [0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0],
                    ],
                ],
            ]
        ),
    ),
    time_units=UnitData("s"),
    spatial_units=UnitData("um"),
    plots=["plot data goes here"],
)


@pytest.mark.parametrize(
    "max_frames, max_bytes, expected_data, expected_format",
    [
        (
            BINARY_SETTINGS.MAX_FRAMES,
            BINARY_SETTINGS.MAX_BYTES,
            [
                [
                    BINARY_SETTINGS.HEADER
                    + "".join(str(i) for i in BINARY_SETTINGS.VERSION),
                    3,
                    20,
                    125,
                    227,
                    0,
                    0.0,
                    5,
                    1000.0,
                    0.0,
                    0.0,
                    4.89610492,
                    -29.81564851,
                    40.77254057,
                    0.0,
                    0.0,
                    0.0,
                    8.38656327,
                    0.0,
                    1001.0,
                    1.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -243.14059805,
                    207.75566987,
                    -95.33921063,
                    -20.54663446,
                    475.97201603,
                    14.43506311,
                    -76.45581828,
                    -97.31170699,
                    -144.30184731,
                    1001.0,
                    2.0,
                    2.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    12.0,
                    108.28447939,
                    175.55049775,
                    -274.34792273,
                    13.44237701,
                    258.21483663,
                    -65.05452787,
                    224.55922362,
                    -455.56482869,
                    -351.23389958,
                    -286.95502659,
                    330.12683064,
                    183.79420473,
                    1000.0,
                    3.0,
                    3.0,
                    43.43048197,
                    48.00424379,
                    -36.02881338,
                    0.0,
                    0.0,
                    0.0,
                    6.18568039,
                    0.0,
                    1001.0,
                    4.0,
                    4.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    49.76236816,
                    -353.11708296,
                    226.84570983,
                    -234.5462914,
                    105.46507228,
                    17.16552317,
                    BINARY_SETTINGS.EOF,
                    1,
                    1.0,
                    5,
                    1001.0,
                    0.0,
                    5.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -442.27202981,
                    202.83568625,
                    -262.13407113,
                    -372.23130078,
                    217.21997368,
                    404.88561338,
                    171.37918011,
                    205.80515525,
                    -65.95336727,
                    1000.0,
                    1.0,
                    6.0,
                    -43.37181102,
                    -13.41127423,
                    -17.31316927,
                    0.0,
                    0.0,
                    0.0,
                    6.69209780,
                    0.0,
                    1001.0,
                    2.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    245.9111405,
                    372.15936027,
                    -261.94702214,
                    3.50037066,
                    441.92904046,
                    321.75701298,
                    146.23928574,
                    -315.3241668,
                    82.00405173,
                    1001.0,
                    3.0,
                    7.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    104.82606074,
                    -413.76671598,
                    366.66127719,
                    136.7228888,
                    -210.69313998,
                    -465.59967482,
                    1000.0,
                    4.0,
                    6.0,
                    9.62132397,
                    13.4774314,
                    -20.30846039,
                    0.0,
                    0.0,
                    0.0,
                    9.88033853,
                    0.0,
                    BINARY_SETTINGS.EOF,
                    2,
                    2.0,
                    5,
                    1000.0,
                    0.0,
                    8.0,
                    -24.91450698,
                    -44.79360525,
                    13.32273796,
                    0.0,
                    0.0,
                    0.0,
                    8.91022619,
                    0.0,
                    1000.0,
                    1.0,
                    9.0,
                    4.10861266,
                    43.86451151,
                    21.93697483,
                    0.0,
                    0.0,
                    0.0,
                    9.01379396,
                    0.0,
                    1001.0,
                    2.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -148.70447678,
                    225.27562348,
                    -273.51318785,
                    -5.32043612,
                    -55.97783429,
                    413.32948686,
                    165.64239994,
                    322.63703294,
                    -2.2348818,
                    1001.0,
                    3.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    -317.48515644,
                    -237.70246887,
                    238.69661676,
                    94.56942257,
                    346.13786088,
                    -7.93209392,
                    1001.0,
                    4.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    7.77508859,
                    260.16762947,
                    -171.02427873,
                    -20.46326319,
                    179.43194042,
                    485.07810635,
                    BINARY_SETTINGS.EOF,
                ]
            ],
            [
                "16s4iifi82f20sifi79f20sifi76f20s",
            ],
        ),
        (
            2,
            1000000,
            [
                [
                    BINARY_SETTINGS.HEADER
                    + "".join(str(i) for i in BINARY_SETTINGS.VERSION),
                    2,
                    19,
                    124,
                    0,
                    0.0,
                    5,
                    1000.0,
                    0.0,
                    0.0,
                    4.89610492,
                    -29.81564851,
                    40.77254057,
                    0.0,
                    0.0,
                    0.0,
                    8.38656327,
                    0.0,
                    1001.0,
                    1.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -243.14059805,
                    207.75566987,
                    -95.33921063,
                    -20.54663446,
                    475.97201603,
                    14.43506311,
                    -76.45581828,
                    -97.31170699,
                    -144.30184731,
                    1001.0,
                    2.0,
                    2.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    12.0,
                    108.28447939,
                    175.55049775,
                    -274.34792273,
                    13.44237701,
                    258.21483663,
                    -65.05452787,
                    224.55922362,
                    -455.56482869,
                    -351.23389958,
                    -286.95502659,
                    330.12683064,
                    183.79420473,
                    1000.0,
                    3.0,
                    3.0,
                    43.43048197,
                    48.00424379,
                    -36.02881338,
                    0.0,
                    0.0,
                    0.0,
                    6.18568039,
                    0.0,
                    1001.0,
                    4.0,
                    4.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    49.76236816,
                    -353.11708296,
                    226.84570983,
                    -234.5462914,
                    105.46507228,
                    17.16552317,
                    BINARY_SETTINGS.EOF,
                    1,
                    1.0,
                    5,
                    1001.0,
                    0.0,
                    5.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -442.27202981,
                    202.83568625,
                    -262.13407113,
                    -372.23130078,
                    217.21997368,
                    404.88561338,
                    171.37918011,
                    205.80515525,
                    -65.95336727,
                    1000.0,
                    1.0,
                    6.0,
                    -43.37181102,
                    -13.41127423,
                    -17.31316927,
                    0.0,
                    0.0,
                    0.0,
                    6.69209780,
                    0.0,
                    1001.0,
                    2.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    245.9111405,
                    372.15936027,
                    -261.94702214,
                    3.50037066,
                    441.92904046,
                    321.75701298,
                    146.23928574,
                    -315.3241668,
                    82.00405173,
                    1001.0,
                    3.0,
                    7.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    104.82606074,
                    -413.76671598,
                    366.66127719,
                    136.7228888,
                    -210.69313998,
                    -465.59967482,
                    1000.0,
                    4.0,
                    6.0,
                    9.62132397,
                    13.4774314,
                    -20.30846039,
                    0.0,
                    0.0,
                    0.0,
                    9.88033853,
                    0.0,
                    BINARY_SETTINGS.EOF,
                ],
                [
                    BINARY_SETTINGS.HEADER
                    + "".join(str(i) for i in BINARY_SETTINGS.VERSION),
                    1,
                    18,
                    0,
                    2.0,
                    5,
                    1000.0,
                    0.0,
                    8.0,
                    -24.91450698,
                    -44.79360525,
                    13.32273796,
                    0.0,
                    0.0,
                    0.0,
                    8.91022619,
                    0.0,
                    1000.0,
                    1.0,
                    9.0,
                    4.10861266,
                    43.86451151,
                    21.93697483,
                    0.0,
                    0.0,
                    0.0,
                    9.01379396,
                    0.0,
                    1001.0,
                    2.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -148.70447678,
                    225.27562348,
                    -273.51318785,
                    -5.32043612,
                    -55.97783429,
                    413.32948686,
                    165.64239994,
                    322.63703294,
                    -2.2348818,
                    1001.0,
                    3.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    -317.48515644,
                    -237.70246887,
                    238.69661676,
                    94.56942257,
                    346.13786088,
                    -7.93209392,
                    1001.0,
                    4.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    7.77508859,
                    260.16762947,
                    -171.02427873,
                    -20.46326319,
                    179.43194042,
                    485.07810635,
                    BINARY_SETTINGS.EOF,
                ],
            ],
            [
                "16s3iifi82f20sifi79f20s",
                "16s2iifi76f20s",
            ],
        ),
        (
            100,
            800,
            [
                [
                    BINARY_SETTINGS.HEADER
                    + "".join(str(i) for i in BINARY_SETTINGS.VERSION),
                    2,
                    19,
                    124,
                    0,
                    0.0,
                    5,
                    1000.0,
                    0.0,
                    0.0,
                    4.89610492,
                    -29.81564851,
                    40.77254057,
                    0.0,
                    0.0,
                    0.0,
                    8.38656327,
                    0.0,
                    1001.0,
                    1.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -243.14059805,
                    207.75566987,
                    -95.33921063,
                    -20.54663446,
                    475.97201603,
                    14.43506311,
                    -76.45581828,
                    -97.31170699,
                    -144.30184731,
                    1001.0,
                    2.0,
                    2.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    12.0,
                    108.28447939,
                    175.55049775,
                    -274.34792273,
                    13.44237701,
                    258.21483663,
                    -65.05452787,
                    224.55922362,
                    -455.56482869,
                    -351.23389958,
                    -286.95502659,
                    330.12683064,
                    183.79420473,
                    1000.0,
                    3.0,
                    3.0,
                    43.43048197,
                    48.00424379,
                    -36.02881338,
                    0.0,
                    0.0,
                    0.0,
                    6.18568039,
                    0.0,
                    1001.0,
                    4.0,
                    4.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    49.76236816,
                    -353.11708296,
                    226.84570983,
                    -234.5462914,
                    105.46507228,
                    17.16552317,
                    BINARY_SETTINGS.EOF,
                    1,
                    1.0,
                    5,
                    1001.0,
                    0.0,
                    5.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -442.27202981,
                    202.83568625,
                    -262.13407113,
                    -372.23130078,
                    217.21997368,
                    404.88561338,
                    171.37918011,
                    205.80515525,
                    -65.95336727,
                    1000.0,
                    1.0,
                    6.0,
                    -43.37181102,
                    -13.41127423,
                    -17.31316927,
                    0.0,
                    0.0,
                    0.0,
                    6.69209780,
                    0.0,
                    1001.0,
                    2.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    245.9111405,
                    372.15936027,
                    -261.94702214,
                    3.50037066,
                    441.92904046,
                    321.75701298,
                    146.23928574,
                    -315.3241668,
                    82.00405173,
                    1001.0,
                    3.0,
                    7.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    104.82606074,
                    -413.76671598,
                    366.66127719,
                    136.7228888,
                    -210.69313998,
                    -465.59967482,
                    1000.0,
                    4.0,
                    6.0,
                    9.62132397,
                    13.4774314,
                    -20.30846039,
                    0.0,
                    0.0,
                    0.0,
                    9.88033853,
                    0.0,
                    BINARY_SETTINGS.EOF,
                ],
                [
                    BINARY_SETTINGS.HEADER
                    + "".join(str(i) for i in BINARY_SETTINGS.VERSION),
                    1,
                    18,
                    0,
                    2.0,
                    5,
                    1000.0,
                    0.0,
                    8.0,
                    -24.91450698,
                    -44.79360525,
                    13.32273796,
                    0.0,
                    0.0,
                    0.0,
                    8.91022619,
                    0.0,
                    1000.0,
                    1.0,
                    9.0,
                    4.10861266,
                    43.86451151,
                    21.93697483,
                    0.0,
                    0.0,
                    0.0,
                    9.01379396,
                    0.0,
                    1001.0,
                    2.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    9.0,
                    -148.70447678,
                    225.27562348,
                    -273.51318785,
                    -5.32043612,
                    -55.97783429,
                    413.32948686,
                    165.64239994,
                    322.63703294,
                    -2.2348818,
                    1001.0,
                    3.0,
                    10.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    -317.48515644,
                    -237.70246887,
                    238.69661676,
                    94.56942257,
                    346.13786088,
                    -7.93209392,
                    1001.0,
                    4.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    6.0,
                    7.77508859,
                    260.16762947,
                    -171.02427873,
                    -20.46326319,
                    179.43194042,
                    485.07810635,
                    BINARY_SETTINGS.EOF,
                ],
            ],
            [
                "16s3iifi82f20sifi79f20s",
                "16s2iifi76f20s",
            ],
        ),
    ],
)
def test_binary_writer(max_frames, max_bytes, expected_data, expected_format):
    converter = TrajectoryConverter(input_data)
    buffer_data, format_strings = BinaryWriter.format_trajectory_data(
        converter._data, max_frames, max_bytes
    )
    for chunk_index in range(len(buffer_data)):
        for item_index in range(len(buffer_data[chunk_index])):
            item = buffer_data[chunk_index][item_index]
            if isinstance(item, float):
                assert item == pytest.approx(expected_data[chunk_index][item_index])
            else:
                assert item == expected_data[chunk_index][item_index]
        assert format_strings[chunk_index] == expected_format[chunk_index]
